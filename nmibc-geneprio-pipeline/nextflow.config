/*
  nextflow.config - Configuration file for the nmibc-geneprio Nextflow pipeline

  This configuration file defines parameters, Singularity/Apptainer container settings, 
  process-level resource allocations, and executor options for the nmibc-geneprio workflow.

  Sections:
  - params: Pipeline parameters controlling which analyses to run (eQTL, coloc, FUSION, prioritization),
    p-value thresholds, and file paths for GWAS, eQTL, FUSION, and prioritization input/output.
  - singularity: Containerization settings using Apptainer (Singularity), including global and 
    process-specific bind mounts for data and container images.
  - process: Default and process-specific resource allocations (container image, CPUs, threading environment variables),
    with overrides for FUSION_TWAS and COLOC_ANALYSIS steps.
  - executor: Limits the number of concurrent jobs in the workflow.

  Usage:
  - Adjust file paths and parameters as needed for your data and analysis requirements.
  - Ensure all referenced files and container images exist at the specified locations.
  - This configuration is intended for use with Nextflow and Apptainer/Singularity on a Linux system.
*/
// nextflow.config

// force Nextflow to create work/ inside your repo
workDir = './work'

params {
  run_eqtl            = false
  run_coloc           = true
  run_fusion          = false
  run_prioritization  = false
  pvalue_threshold    = 0.000001

  gwas_file           = "/home/hbashir1/nmibc-geneprio/Data/metaGWAS_outputbestand/MA_STDERR_gwas_prognose_update_maf005_r208_progr_1.tbl"
  // coloc params
  eqtl_file     = "/home/hbashir1/nmibc-geneprio/Data/BCG/eGenes_top_snps_by_symbol.tsv"

  // fusion params
  weights_dir         = "/home/hbashir1/nmibc-geneprio/Data/TWAS/tcga_expr_model/TCGA-BLCA.TUMOR_locus"
  ld_dir              = "/home/hbashir1/nmibc-geneprio/Data/TWAS/fusion_LD"
  weights_list        = "/home/hbashir1/nmibc-geneprio/Data/TWAS/tcga_expr_model/TCGA-BLCA.TUMOR.final.wglist.txt"

  // gene prioritization params
  eqtl_result_file       = "/home/hbashir1/nmibc-geneprio/results/eqtl_lookup/eqtl_lookup_result.txt"
  coloc_candidates_file  = "/home/hbashir1/nmibc-geneprio/results/coloc/coloc_hypotheses_summary.txt"
  fusion_results_dir     = "/home/hbashir1/nmibc-geneprio/results/fusion"
}


singularity {
  enabled    = true
  engine     = 'apptainer'   // force Apptainer if both are installed
  autoMounts = true

  // Global binds go *before* the .sif in the exec call:
  binds = [
    '/gpfs/home2/hbashir1:/home/hbashir1',             // <— mount entire home
    '/home/hbashir1/Data:/home/hbashir1/Data',
    '/home/hbashir1/nmibc-geneprio:/home/hbashir1/nmibc-geneprio'
  ]

  // Extra bind only for the FUSION_TWAS process:
  process {
    withName: 'FUSION_TWAS' {
      binds = [
        '/home/hbashir1/nmibc-geneprio/containers/fusion_twas:/fusion_twas'
      ]
    }
  }
}

process {
  // default image for all steps
  container = '/home/hbashir1/nmibc-geneprio/containers/fusion.sif'

  // keep your threading settings
  cpus = 16
  env.OPENBLAS_NUM_THREADS = '1'
  env.OMP_NUM_THREADS       = '1'

  // fusion‐specific CPU parallelism
  withName: 'FUSION_TWAS' {
    // still only 1 CPU per task…
    cpus     = 16
    // …but at most 4 parallel jobs
    maxForks = 1
  }

  // coloc uses the same image, no extra binds needed here
  withName: 'COLOC_ANALYSIS' {
    cpus     = 12       // each coloc job uses 12 cores
    maxForks = 5        // 12 × 5 = 60 cores total
    memory   = '8 GB'
    container = '/home/hbashir1/nmibc-geneprio/containers/fusion.sif'
    containerOptions = '--bind ~/Rlibs:/usr/local/lib/R/site-library'
  }
}

executor {
  queueSize = 10
}
